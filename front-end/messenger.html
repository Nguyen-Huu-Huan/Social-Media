<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8">
  <title>Messenger</title>
  <link rel="stylesheet" href="css/messenger.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta2/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.6.0/font/bootstrap-icons.css">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500&display=swap" rel="stylesheet">
</head>

<body>
  <section class="top">
    <a href="#" class="logo_a col-20"><img src="logo.png" alt="logo" class="logo_img"></a>
    <div class="group_header col-50 row" style="display: flex;justify-content: space-between;">
      <div class="top_group_buttons row" style="font-size: 2rem;display: flex; justify-content: center; align-items: center;">
        <div class="group_button_wrapper">
          <i class="bi bi-pin-angle"></i>
        </div>
        <div class="group_button_wrapper appearance_setting">
          <i class="bi bi-brush"></i>
        </div>
        <div class="group_button_wrapper">
          <i class="bi bi-gear"></i>
        </div>
      </div>
      <div class="color_menu">
        <li>
          <div>
            <input type="color" id="change_box_color">
            <input type="color" id="change_box_color1">
          </div>
          <span>Box chat color</span>
        </li>
        <li>
          <div>
          <input type="color" id="change_background_color">
          </div>
          <span>Background color</span>
        </li>
      </div>
      <div class="group_info_wrapper row">
        <div class="group_info">
          <h1>Building IT System</h1>
          <div class="row">
            <p class="online_status_p">Online |</p>
            <div class="online_status_img_container">
              <img src="https://img.icons8.com/wired/64/000000/circled.png" class="online_status_img">
            </div>
          </div>
        </div>
        <div class="group_image">
          <img src="group_logo.jpg" alt="">
        </div>
      </div>
    </div>
    <div class="utility_wrapper">
      <div class="search_bar_div">
        <input type="text" name="" value="" placeholder="Search Message.." class="search_bar_input" onfocus="lighten_search_bar()" onblur="darken_search_bar()">
        <i class="fa fa-search search_icon" aria-hidden="true"></i>
      </div>
      <div class="row utility_button" style="justify-content:space-around; max-width: 8rem;">
        <div class="icon_button_wrapper" style="cursor:pointer;">
          <i class="bi bi-list-ul" style="font-size: 2.5rem;" id="details_toggle"></i>
          <span id="toggle_details">Toggle Details</span>
        </div>
        <div class="icon_button_wrapper">
          <a href="profile.html"><i class="bi bi-x-circle" style="font-size: 2.5rem;"></i></a>
        </div>
      </div>

    </div>

  </section>
  <section class="body row">
    <div class="side_group_icon col-5">
      <div class="add_group">
        <i class="fas fa-plus" id="add_group_button"></i>
        <div class="group_dialog">
          <div class="group_dialog_row1">
            <div class="show_image">
              <img src="group_logo.jpg" alt="" style="width: 160px; height:160px; object-fit: cover;">
            </div>
            <button class="camera_button" onclick='Openimagefile()'>
              <i class="bi bi-camera"></i>  
              <input type="file" accept="image/*" class="image_upload">          
            </button>
            <button class="exit_creategroup"><i class="fas fa-sign-out-alt"></i></button>
          </div>
          <input type="text" class="input_group_name" placeholder="Enter your group name">
          <input type="text" class="input_group_description" placeholder="Enter short description for your group">
          <div class="commit_button">
            <span class="add_group_error"></span>
            <button class="create_group">Create a new group</button>
          </div>  
        </div>
      </div>
      <div class="group_collections">
      </div>
      
      
      <!-- <a href="#">
        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="white" class="bi bi-plus" viewBox="0 0 16 16">
          <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"></path>
        </svg>
      </a> -->
      


    </div>
    <div class="chatting_area">
      <div class="chat_box_container">
      </div>
      <div class="typing_area">
        <form class="row input_form_wrapper" action="index.html" method="post">
          <input type="text" name="" value="" class="input_chat" placeholder="Type messages">
          <div class="adding_files">
            <div class="adding_file_wrapper">
              <a class="adding_file_button post_action_button">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus" viewBox="0 0 16 16">
                  <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z" />
                </svg>
              </a>
              <div class="upload_function_div">
                <div class="upload_file row">
                  <div class="post_action_icon_wrapper col-20">
                    <i class="bi bi-archive-fill"></i>
                  </div>
                  <div class="">
                    <h4>Upload file</h4>
                    <p>zip, docx, pptx, txt</p>
                  </div>
                </div>
                <div class="upload_media row">
                  <div class="post_action_icon_wrapper col-20">
                    <i class="bi bi-play-circle-fill"></i>
                  </div>
                  <div class="post_action_content">
                    <h4>Upload Media</h4>
                    <p class="">png, jpg, gif, mp4, mp3, etc.</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
    <div class="group_details col-30">
      <div class="detail1">
        <h1>Details</h1>
      </div>
      <div class="detail2">
        <div class="current_user">
          <img src="group_logo.jpg" alt="">
        </div>
        <a href="#" class="callimage">
          <i class="bi bi-camera"></i>
        </a>
      </div>
      <div class="detail3">
        <div class="current_user_name">Alan Walker</div>
        <div class="nickname">
          <span id='nickname'>This is a nickname</span>
          <button type="button" name="button" onclick='OpenChangeBox()' class="changenickname"><i class="fas fa-plus plus"></i></button>

        </div>
      </div>

      <div class="detail4">
        <div class="detail4_button_wrapper">
          <button type="button" name="button" class="paperclip_func"><i class="fas fa-paperclip"></i></button>
          <span id="paperclip">Papper Clip</span>
        </div>
        <div class="detail4_button_wrapper">
          <button type="button" name="button" class="info_func"><i class="fas fa-info"></i></button>
          <span id="groupinformation">Group Information</span>
        </div>
        <div class="detail4_button_wrapper">
          <button type="button" name="button" class="users_func"><i class="fas fa-users"></i></button>
          <span id="users">Users</span>
        </div>
      </div>
      <hr>
      <div class="detail5">
        <div>Channels</div>
        <ul>
          <li>
            <button>test function 1</button>
          </li>
          <li>
            <button>test function 2</button>
          </li>
          <li>
            <button>test function 3</button>
          </li>
        </ul>
      </div>
    </div>
  </section>
  <div class="change_logic">
    <div class="description">Enter your name here:</div>
    <div class="">
      <input type="text" name="" value="" placeholder="Enter a nickname" class="change_input">
      <button type="button" name="button" onclick='CloseChangeBox()' id="change_input">Change</button>
      <div class='nickname_error'></div>
    </div>
  </div>
  <script type="text/javascript" src="javascript/messenger.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    function hover_show_items(){
    var group_name_elms = document.querySelectorAll(".group_name");
    var group_logo_elms = document.querySelectorAll(".group_logo");
    var side_group_icon = document.querySelector(".side_group_icon");
    group_logo_elms.forEach((item, i) => {
      group_logo_elms[i].addEventListener("mouseover", function(){
        group_name_elms[i].style.opacity = "1"
        side_group_icon.style = "flex-basis: 20%"
        group_details.style = "flex-basis: 20%"
      })
      group_logo_elms[i].addEventListener("mouseout", function(){
        group_name_elms[i].style.opacity = "0"
        side_group_icon.style = "flex-basis: 5%"
        group_details.style = "flex-basis: 30%"
      })

    })
    var chat_box_elms = document.querySelectorAll(".chat_box");
    var logo_background = document.querySelectorAll(".group_list");
    group_logo_elms.forEach((item, i) => {
      group_logo_elms[i].addEventListener("click", function(){
        group_current_index = i+1;
        logo_background[i].style.background = "linear-gradient(43deg, #4158D0 0%, #C850C0 46%, #FFCC70 100%)"
        chat_box_elms[i].style.display = "block"; 
        active_change_color(chat_box_elms[i])
        logo_background.forEach((item, j) => {
          if (i != j){
            logo_background[j].style.background = "none";
            chat_box_elms[j].style.display = "none"; 
          }
        })
      })
    })
  }
    var commit_button = document.querySelector(".commit_button>button");
    var input_group_name = document.querySelector(".input_group_name");
    var input_group_description = document.querySelector(".input_group_description");
    var error_notification = document.querySelector(".add_group_error");
    var add_group_box = document.querySelector(".group_dialog");
    commit_button.addEventListener("click", function(){
    if ((input_group_name.value.length > 15) || (input_group_description.value > 15)){
      error_notification.textContent = "Invalid! No more than 15 characters"
      console.log("error")
    }
    else{
      var image_commit = document.querySelector(".show_image *").getAttribute('src');
      document.querySelector(".group_collections").insertAdjacentHTML("beforeend", `<div class="group_list"><div><img src="${image_commit}" alt="" class="group_logo"><img src="https://img.icons8.com/material-outlined/24/000000/filled-circle--v2.png" class="online_status_2" style="width: 15px; height: 15px;"><span class="group_name">${input_group_name.value}</span></div></div>`)
      var new_group_index = document.querySelectorAll('.group_list').length;
      document.querySelector(".chat_box_container").insertAdjacentHTML("beforeend", `<div class="chat_box`+` chat_box_${new_group_index}"></div>`)
      room_information = {'creator': localStorage.getItem('login token'),'name': input_group_name.value, 'description': input_group_description.value, 'member': ['s3912345', 's3500000']};
      error_notification.textContent= ""
      input_group_name.value = ""
      input_group_description.value = ""
      add_group_box.style.display = "none"
      console.log(room_information);
      socket.emit('create_new_room', room_information);
      hover_show_items()
    }
  })
    var current_time = new Date().toLocaleString((window.navigator.userLanguage || window.navigator.language), {
            hour: 'numeric',
            minute: 'numeric',
            second: 'numeric',
    });
    var group_current_index = 1;
    var total_group = 1;
    var current_time = new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true });
    document.querySelector('.commit_button').addEventListener('click', () => {
      let group_name = document.querySelector('.input_group_name').value;
      let group_description = document.querySelector('.input_group_description').value;
      socket.emit('add_group',{'name': group_name, 'description': group_description});
    });
    document.querySelector('.input_form_wrapper').addEventListener('submit', (e) => {
      e.preventDefault();
      let colorpicker_current_color = document.getElementById("change_background_color").value;
      let hex_to_rgb = [parseInt(colorpicker_current_color.charAt(1)+colorpicker_current_color.charAt(2), 16), parseInt(colorpicker_current_color.charAt(3)+colorpicker_current_color.charAt(4), 16), parseInt(colorpicker_current_color.charAt(5)+colorpicker_current_color.charAt(6), 16)];
      let message_p_color = "";
      if (Math.round(hex_to_rgb[0] * 0.299+hex_to_rgb[1] * 0.587+hex_to_rgb[2] * 0.114)>125){
          message_p_color = "black";
      }else{
          message_p_color = "white";
      }      
      message = document.querySelector('.input_chat').value;
      document.querySelector('.input_chat').value = "";
      var background_color = document.getElementById("change_background_color").value;
      console.log(document.querySelector('.chat_box_'+group_current_index.toString()));
      document.querySelector('.chat_box_'+group_current_index.toString()).insertAdjacentHTML('beforeend', `<div class="message m_sent"><div class="content" ` + `style="background: ${colorpicker_current_color};">` + `<p style="color: ${message_p_color};">` + `${message}</p><span class="message_time_sent">${current_time}</span></div></div>`);
      socket.emit('message_sent', {'content': message, 'room': group_current_index});
      document.querySelector('.chat_box').scrollTo(0,document.querySelector('.chat_box').scrollHeight);
    })
    
    socket.on('join_chat', (message) => {
      // document.querySelector('.chat_box').insertAdjacentHTML('beforeend', `<p style="text-align:center;">${message}</p>`);
    })
    socket.on('user-chat', (message) => {     
      console.log(message['room']);
      document.querySelector('.chat_box_'+message['room'].toString()).insertAdjacentHTML('beforeend', `<div class="message m_received"><div class="chat_user_img_wrapper"><img src="default_profile_image.jpg" alt="" class="chat_user_img"></div><div class="content"><p>`+message['content']+`</p><span class="message_time_received">${current_time}</span></div></div>`);
      document.querySelector('.chat_box_'+group_current_index.toString()).insertAdjacentHTML('beforeend', `<audio class="new_message_noti" controls autoplay style="display: none;"><source src="new_message_noti.mp3"></audio>`);
      document.querySelector('.new_message_noti').play();
      document.querySelector('.chat_box_'+group_current_index.toString()).scrollTo(0,document.querySelector('.chat_box').scrollHeight);
    })
    socket.on('user-disconnect', (message) => {
      // document.querySelector('.chat_box').insertAdjacentHTML('beforeend', `<p style="text-align: center;">${message}</p>`)
    })
    let colorpicker = document.getElementById("change_background_color");

    colorpicker.addEventListener("input", function(){
        hex = colorpicker.value;        
        socket.emit('message_sender_background', hex);
    });
    socket.on('change_sender_chat_background', data => {
      let background_message_sent = document.querySelectorAll("div.m_sent>.content");
      let text = document.querySelectorAll("div.m_sent>.content>p");
      let hex_to_rgb = [parseInt(data.charAt(1)+data.charAt(2), 16), parseInt(data.charAt(3)+data.charAt(4), 16), parseInt(data.charAt(5)+data.charAt(6), 16)];
      background_message_sent.forEach((item, i) => {
        item.style.background = data;
        if (Math.round(hex_to_rgb[0] * 0.299+hex_to_rgb[1] * 0.587+hex_to_rgb[2] * 0.114)>125){
          text[i].style.color = "black";
        }else{
          text[i].style.color = "white";
        }
      });
    });
    socket.emit('localStorage', localStorage.getItem('login token'));
    socket.on('loggedin_process', function(data){
      data['room_list'].forEach(room => {
        document.querySelector(".group_collections").insertAdjacentHTML("beforeend", `<div class="group_list"><div><img src="group_logo.jpg" alt="" class="group_logo"><img src="https://img.icons8.com/material-outlined/24/000000/filled-circle--v2.png" class="online_status_2" style="width: 15px; height: 15px;"><span class="group_name">${room}</span></div></div>`)

      })
    })
    
  </script>
</body>

</html>
